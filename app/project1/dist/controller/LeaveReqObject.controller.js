sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel"],function(e,t,n){"use strict";async function o(e,t){for(const n of t){if(n.fileName===e&&n.fileObject){return await n.fileObject.arrayBuffer()}}return null}return e.extend("project1.controller.LeaveReqObject",{onInit:function(){const e=new n({items:[]});this.getView().setModel(e,"documents")},onBeforeUploadStarts:async function(e){const n=e.getParameter("item");const o=await(n.getFileObject?.());if(!o){t.show("No file selected.");return}const a=await this.fileToBase64(o);const s=this.getView().getModel("documents");const i=s.getProperty("/items")||[];i.push({fileName:o.name,mediaType:o.type,fileSize:o.size,fileObject:o,content:a,ID:null});s.setProperty("/items",i);e.preventDefault();t.show("File stored locally.")},fileToBase64(e){return new Promise((t,n)=>{const o=new FileReader;o.onload=()=>{const e=o.result.split(",")[1];t(e)};o.onerror=n;o.readAsDataURL(e)})},onCreate:async function(){debugger;const e=this.getView();const n=this.getOwnerComponent().getModel();const o=n.getServiceUrl();const a=e.byId("inputEmployeeName").getValue();const s=e.byId("inputLeaveType").getSelectedItem()?.getText();const i=e.byId("inputStartDate").getValue();const r=e.byId("inputEndDate").getValue();const c=e.byId("inputReason").getValue();const l=e.byId("inputStatus").getValue()||"Pending";if(!a||!s||!i||!r){t.show("Please fill in all required fields.");return}const u=e.getModel("documents");const d=u.getProperty("/items")||[];const f=d[0];if(!f||!f.fileObject){t.show("File content missing. Please upload again.");return}try{const e=n.bindContext("/addLeaveRequest(...)");e.setParameter("employeeName",a).setParameter("leaveType",s).setParameter("startDate",i).setParameter("endDate",r).setParameter("reason",c).setParameter("status",l);await e.execute();const o=await e.getBoundContext().requestObject();const u=o.ID;const f=d[0];const m=await this.fileToBase64(f.fileObject);const p=n.bindContext("/addFileToLeave(...)");p.setParameter("leaveID",u);p.setParameter("fileName",f.fileName);p.setParameter("mediaType",f.mediaType);p.setParameter("size",f.fileSize);p.setParameter("content",m);await p.execute();t.show("Leave request submitted with file.");this.onCancel()}catch(e){console.error("Upload failed:",e);t.show("Leave request failed.")}},onCancel:function(){this.getOwnerComponent().getRouter().navTo("RouteView1")},openPreview:async function(e){debugger;const n=e.getSource().getBindingContext("documents");const o=n.getObject();const a=o.content;const s=o.fileName;const i=o.mediaType||"application/octet-stream";if(a){const e=atob(a);const t=new Array(e.length);for(let n=0;n<e.length;n++){t[n]=e.charCodeAt(n)}const n=new Uint8Array(t);const o=new Blob([n],{type:i});const s=URL.createObjectURL(o);window.open(s,"_blank");return}const r=o.ID;if(!r){t.show("File not yet saved. Please submit first.");return}try{const e=this.getView().getModel();const n=e.getServiceUrl();const o=await fetch(`${n}Files(ID=${r},IsActiveEntity=true)`);const a=await o.json();if(!a.content){t.show("No content found in database.");return}const s=a.content;const i=a.mediaType||"application/octet-stream";const c=atob(s);const l=new Array(c.length);for(let e=0;e<c.length;e++){l[e]=c.charCodeAt(e)}const u=new Uint8Array(l);const d=new Blob([u],{type:i});const f=URL.createObjectURL(d);window.open(f,"_blank")}catch(e){console.error("Preview failed:",e);t.show("Failed to load preview.")}}})});
//# sourceMappingURL=LeaveReqObject.controller.js.map